-- ###########################################
-- # Drop
-- ###########################################
-- Drop index

-- Drop many to many relations
DROP TABLE DEPLOYMENT_TASK CASCADE;

-- Drop normal entities
DROP TABLE TIMELINE CASCADE;
DROP TABLE DEPLOYMENT CASCADE;
DROP TABLE COMMUNICATION CASCADE;
DROP TABLE ENDUSER CASCADE;
DROP TABLE TASK CASCADE;
DROP TABLE PROJECT CASCADE;

-- Drop pk sequence
DROP SEQUENCE hibernate_sequence;

-- ###########################################
-- # Create
-- ###########################################
-- Create pk sequence
CREATE SEQUENCE hibernate_sequence;

-- Create normal entities
CREATE TABLE PROJECT (
	ID BIGINT NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION VARCHAR(100) NOT NULL,
	LAUNCHDATE TIMESTAMP NOT NULL,
	UUID VARCHAR(36) NOT NULL,
	CREATEDDATE TIMESTAMP,
	CREATEDBY VARCHAR(50),
	LASTUPDATED TIMESTAMP,
	LASTUPDATEDBY VARCHAR(50),
	VERSION BIGINT NOT NULL
);

CREATE TABLE TASK (
	ID BIGINT NOT NULL,
	PROJECTID BIGINT NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION VARCHAR(100) NOT NULL,
	ORIGINDATE TIMESTAMP NOT NULL,
	DEADLINE TIMESTAMP NOT NULL,
	UUID VARCHAR(36) NOT NULL,
	TASKTYPE VARCHAR(13) NOT NULL,
	PRIORITY VARCHAR(6) NOT NULL,
	STATUS VARCHAR(8) NOT NULL,
	PLACEMENT VARCHAR(4) NOT NULL,
	PROJECT BIGINT NOT NULL,
	CREATEDDATE TIMESTAMP,
	CREATEDBY VARCHAR(50),
	LASTUPDATED TIMESTAMP,
	LASTUPDATEDBY VARCHAR(50),
	VERSION BIGINT NOT NULL
);

CREATE TABLE ENDUSER (
	ID BIGINT NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	ROLE VARCHAR(100) NOT NULL,
	UUID VARCHAR(36) NOT NULL,
	CREATEDDATE TIMESTAMP,
	CREATEDBY VARCHAR(50),
	LASTUPDATED TIMESTAMP,
	LASTUPDATEDBY VARCHAR(50),
	VERSION BIGINT NOT NULL
);

CREATE TABLE COMMUNICATION (
	ID BIGINT NOT NULL,
	TASKID BIGINT NOT NULL,
	SENDERNAME VARCHAR(100) NOT NULL,
	RECIPIENTNAME VARCHAR(100) NOT NULL,
	CONTENT VARCHAR(100) NOT NULL,
	DATE TIMESTAMP NOT NULL,
	UUID VARCHAR(36) NOT NULL,
	TASK BIGINT NOT NULL,
	SENDER BIGINT NOT NULL,
	RECIPIENT BIGINT NOT NULL,
	CREATEDDATE TIMESTAMP,
	CREATEDBY VARCHAR(50),
	LASTUPDATED TIMESTAMP,
	LASTUPDATEDBY VARCHAR(50),
	VERSION BIGINT NOT NULL
);

CREATE TABLE DEPLOYMENT (
	ID BIGINT NOT NULL,
	LABEL VARCHAR(100) NOT NULL,
	DATE TIMESTAMP NOT NULL,
	UUID VARCHAR(36) NOT NULL,
	ENVIRONMENT VARCHAR(4) NOT NULL,
	CREATEDDATE TIMESTAMP,
	CREATEDBY VARCHAR(50),
	LASTUPDATED TIMESTAMP,
	LASTUPDATEDBY VARCHAR(50),
	VERSION BIGINT NOT NULL
);

CREATE TABLE TIMELINE (
	ID BIGINT NOT NULL,
	DATE TIMESTAMP NOT NULL,
	LABEL VARCHAR(100) NOT NULL,
	UUID VARCHAR(36) NOT NULL,
	PERSON BIGINT NOT NULL,
	TASK BIGINT NOT NULL,
	CREATEDDATE TIMESTAMP,
	CREATEDBY VARCHAR(50),
	LASTUPDATED TIMESTAMP,
	LASTUPDATEDBY VARCHAR(50),
	VERSION BIGINT NOT NULL
);


-- Create many to many relations
CREATE TABLE DEPLOYMENT_TASK (
	TASK BIGINT NOT NULL,
	DEPLOYMENT BIGINT NOT NULL
);


-- Primary keys
ALTER TABLE PROJECT ADD CONSTRAINT PK_PROJECT
	PRIMARY KEY (ID);
ALTER TABLE TASK ADD CONSTRAINT PK_TASK
	PRIMARY KEY (ID);
ALTER TABLE ENDUSER ADD CONSTRAINT PK_ENDUSER
	PRIMARY KEY (ID);
ALTER TABLE COMMUNICATION ADD CONSTRAINT PK_COMMUNICATION
	PRIMARY KEY (ID);
ALTER TABLE DEPLOYMENT ADD CONSTRAINT PK_DEPLOYMENT
	PRIMARY KEY (ID);
ALTER TABLE TIMELINE ADD CONSTRAINT PK_TIMELINE
	PRIMARY KEY (ID);
ALTER TABLE DEPLOYMENT_TASK ADD CONSTRAINT PK_DEPLOYMENT_TASK
	PRIMARY KEY (TASK, DEPLOYMENT);

-- Unique constraints
ALTER TABLE PROJECT
	ADD CONSTRAINT UQ_PROJECT UNIQUE (UUID);
ALTER TABLE TASK
	ADD CONSTRAINT UQ_TASK UNIQUE (UUID);
ALTER TABLE ENDUSER
	ADD CONSTRAINT UQ_ENDUSER UNIQUE (UUID);
ALTER TABLE COMMUNICATION
	ADD CONSTRAINT UQ_COMMUNICATION UNIQUE (UUID);
ALTER TABLE DEPLOYMENT
	ADD CONSTRAINT UQ_DEPLOYMENT UNIQUE (UUID);
ALTER TABLE TIMELINE
	ADD CONSTRAINT UQ_TIMELINE UNIQUE (UUID);

-- Foreign key constraints


-- Reference from Task.project to Project
ALTER TABLE TASK ADD CONSTRAINT FK_TASK_PROJECT
	FOREIGN KEY (PROJECT) REFERENCES PROJECT (ID);
CREATE INDEX IX_TASK_PROJECT ON TASK (PROJECT);

-- Reference from Communication.task to Task
ALTER TABLE COMMUNICATION ADD CONSTRAINT FK_COMMUNICATION_TASK
	FOREIGN KEY (TASK) REFERENCES TASK (ID);
CREATE INDEX IX_COMMUNICATION_TASK ON COMMUNICATION (TASK);

-- Reference from Communication.sender to EndUser
ALTER TABLE COMMUNICATION ADD CONSTRAINT FK_COMMUNICATION_SENDER
	FOREIGN KEY (SENDER) REFERENCES ENDUSER (ID);
CREATE INDEX IX_COMMUNICATION_SENDER ON COMMUNICATION (SENDER);

-- Reference from Communication.recipient to EndUser
ALTER TABLE COMMUNICATION ADD CONSTRAINT FK_COMMUNICATION_RECIPIENT
	FOREIGN KEY (RECIPIENT) REFERENCES ENDUSER (ID);
CREATE INDEX IX_COMMUNICATION_RECIPIENT ON COMMUNICATION (RECIPIENT);

-- Reference from TimeLine.person to EndUser
ALTER TABLE TIMELINE ADD CONSTRAINT FK_TIMELINE_PERSON
	FOREIGN KEY (PERSON) REFERENCES ENDUSER (ID);
CREATE INDEX IX_TIMELINE_PERSON ON TIMELINE (PERSON);

-- Reference from TimeLine.task to Task
ALTER TABLE TIMELINE ADD CONSTRAINT FK_TIMELINE_TASK
	FOREIGN KEY (TASK) REFERENCES TASK (ID);
CREATE INDEX IX_TIMELINE_TASK ON TIMELINE (TASK);

-- Reference from DEPLOYMENT_TASK.task to Task
ALTER TABLE DEPLOYMENT_TASK ADD CONSTRAINT FK_DEPLOYMENT_TASK_TASK
	FOREIGN KEY (TASK) REFERENCES TASK (ID);
CREATE INDEX IX_DEPLOYMENT_TASK_TASK ON DEPLOYMENT_TASK (TASK);

-- Reference from DEPLOYMENT_TASK.deployment to Deployment
ALTER TABLE DEPLOYMENT_TASK ADD CONSTRAINT FK_DEPLOYMENT_TASK_DEPLOYMENT
	FOREIGN KEY (DEPLOYMENT) REFERENCES DEPLOYMENT (ID);
CREATE INDEX IX_DEPLOYMENT_TASK_DEPLOYMENT ON DEPLOYMENT_TASK (DEPLOYMENT);

-- Index
